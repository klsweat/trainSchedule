<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="UTF-8">
  <title>Train Schedule</title>

  <!-- jQuery JS -->
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
 
   <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">


  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

  <!-- Font Awesome CSS Icons (For cool glyphicons) -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  <script src="https://momentjs.com/downloads/moment.min.js"></script>

  <!--TIME PICKER -->

  <script type="text/javascript" src="jquery.timepicker.js"></script>
  <link rel="stylesheet" type="text/css" href="assets/css/jquery.timepicker.css" />

  <script type="text/javascript" src="lib/bootstrap-datepicker.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/bootstrap-datepicker.css" />

  <script type="text/javascript" src="lib/site.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/site.css" />

  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="assets/js/bootstrap.min.js"></script>


  <!-- Style to fix the issue of text extending past panel length -->
	
<style type="text/css">

#error{
  color: red;

}

</style>

</head>

<body>
<!-- Main Bootstrap Search -->
  <div class="container">



    <!-- Jumbotron for Title -->
    <div class="jumbotron" style="background-color: black; color: white;">
      <h1 class="text-center"><strong>Train Schedule</strong></h1>
      <h3><center>All Aboard!</center></h3>
    </div>
    <div class="row">
     <div class="col-md-3"></div>
        <div class="col-md-3"></div>
        <div class="col-md-3"></div>
        <div class="col-md-3">
          <div class="bd-example" style="float: right;">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#login-modal">
            Admin Login
            </button>
          </div>
        </div>
      <div class="col-sm-12">

            
               
        <!-- BEGIN # MODAL LOGIN -->
        <div class="modal fade" id="login-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
              <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header" align="center">
                  <h2 class="text-center"><i class="fa fa-train"></i></h2>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                  </button>
                </div>
              
                <!-- Begin # DIV Form -->
        <div id="div-forms">

            <!-- Begin # Login Form -->
            <form id="login-form">
                <div class="modal-body">
                    <div id="div-login-msg">
                        <div id="icon-login-msg" class="glyphicon glyphicon-chevron-right"></div>
                        <span id="text-login-msg">Type your username and password.</span>
                        <br />
                        <br />
                        <span id="error"></span>
                    </div>
                    <input id="login_username" class="form-control" type="text" placeholder="admin" required>
                    <input id="login_password" class="form-control" type="password" placeholder="password" required>
                    <div class="checkbox">
                        <label>
                            <input type="checkbox"> Remember me
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <div>
                        <button type="submit" id="login" class="btn btn-primary btn-lg btn-block">Login</button>
                    </div>

                </div>
            </form>
            <!-- End # Login Form -->


        </div>
        <!-- End # DIV Form -->

        </div>
        </div>
        </div>
        <!-- END # MODAL LOGIN -->       



        <br>
        <!-- This panel will be made up of a table for train info -->
        <div class="panel panel-primary">

          <!-- Panel Heading for the retrieved articles box -->
          <div class="panel-heading">
            <h3 class="panel-title">
            <strong>Employee Data Management</strong></h3>
          </div>
          <div class="panel-body" id="well-section">


           <div class="table-responsive">
            <table class="table table-striped" id="table">
              <thead>
                <tr>
	                <th>Train Name</th>
	                <th>Destination</th>
	                <th>Frequency (min)</th>
	                <th>Next Arrival</th>
	                <th>Minutes Away</th>
                </tr>
              </thead>
              <tbody id="employees">
                <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div><!--/table-responsive-->
        </div><!--/pane-body-->
      </div><!--/panel-primary-->
    </div><!--/col-md-12-->
    </div><!--/row-->


        <!-- First panel is for handling the train search parameters -->
        <div class="panel panel-primary">
          <div class="panel-heading">
            <h3 class="panel-title">
            <strong> Add Train</strong></h3>
          </div>
          <div class="panel-body">
            <!-- Here we create an HTML Form for handling the inputs-->
            <form role="form" id="form">
              <!-- Here we capture the train name-->
              <div class="form-group">
                <label for="employee-input">Train Name:</label>
                <input type="text" class="form-control" id="train-input">
              </div>
              <!-- Here we capture the destination  -->
              <div class="form-group">
                <label for="role-input">Destination:</label>
                <input type="text" class="form-control" id="dest-input">
              </div>
              <!-- Here we capture first train time-->
              <div class="form-group">
                <label for="start-year-input">First Train Time (mm:hh - ex: Milliary):</label>
                <input type="text" class="form-control" id="ftime-input">
              </div>
              <!-- Here we capture the frequency that trains run -->
              <div class="form-group">
                <label for="rate-input">Frequency (min)</label>
                <input type="text" class="form-control" id="frequency-input">
              </div>
              <!-- Here we have our final submit button -->
              <button type="submit" class="btn btn-default" id="add-train"><i class="fa fa-search"></i> Submit</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Footer Region -->
    <div class="row">
      <div class="col-sm-12">
        <!-- Line Break followed by closing -->
        <hr>
        <h5 class="text-center"><small><i class="fa fa-heart"></i></small></h5>
      </div>
    </div>
  </div>

  	<script src="https://www.gstatic.com/firebasejs/3.7.1/firebase.js"></script>

	<script type="text/javascript">
  

             //when you click
            $("#login").on("click", function(){
                //prevent form from submitting
                event.preventDefault();
                  //get username
                  var un = $('#login_username').val().toLowerCase();
                  //get password
                  var pw = $('#login_password').val().toLowerCase();

                  var authun = "admin";
                  var authpw = "password";
                  if (un === authun && pw === authpw) {
                  localStorage.clear();

                  localStorage.setItem("authenticate", "yes");
                  $("#login-modal").modal('hide');
                  $("#error").hide();

                  } else {
                    localStorage.setItem("authenticate", "no");
                    $("#error").html("Invalid Credentials. Please try again.").show();
                  }

            });




	   // Initialize Firebase
	  var config = {
	    apiKey: "AIzaSyA1O7-z2EPI9DS1argWgSedYhh1jzrSr50",
	    authDomain: "multi-project.firebaseapp.com",
	    databaseURL: "https://multi-project.firebaseio.com",
	    storageBucket: "multi-project.appspot.com",
	    messagingSenderId: "835756184831"
	  };
	  firebase.initializeApp(config);

  	// Create a variable to reference the database
  	var database = firebase.database();
   

  	var name = "";
  	var destination = "";
  	var frequency = "";
  	var ftime = "";

  //Displays timepicker plugin, so you don't have to type in
  $(function() {
		  $('#ftime-input').timepicker({ 'timeFormat': 'Hi' });
	 });

  		function putOnPage() {


		//load older conatcts as well as any newly added one...
		database.ref().on("child_added", function(childSnapshot) {

			// Assumptions
		    var tFrequency = childSnapshot.val().frequency;

		    // Time in millitary time
		    var firstTime = childSnapshot.val().ftime;
		    console.log("firstTime: " + firstTime);

		    //console.log(moment('1300','h:mm a').format('h:mm a'));

		    // First Time (pushed back 1 year to make sure it comes before current time)
		    var firstTimeConverted = moment(firstTime, "hh:mm").subtract(1, "years");
		    console.log(firstTimeConverted);

		    // Current Time
		    var currentTime = moment();
		    console.log("CURRENT TIME: " + moment(currentTime).format("hh:mm"));

		    // Difference between the times
		    var diffTime = moment().diff(moment(firstTimeConverted), "minutes");
		    console.log("DIFFERENCE IN TIME: " + diffTime);

		    // Time apart (remainder)
		    var tRemainder = diffTime % tFrequency;
		    console.log(tRemainder);

		    // Minute Until Train
		    var tMinutesTillTrain = tFrequency - tRemainder;
		    console.log("MINUTES TILL TRAIN: " + tMinutesTillTrain);

		    // Next Train
		    var nextTrain = moment().add(tMinutesTillTrain, "minutes");
		    var nextTrainTime = moment(nextTrain).format("hh:mm a");
		    console.log("ARRIVAL TIME: " + moment(nextTrain).format("hh:mm"));


		  $("#employees").append("<tr class='well'><td>" + childSnapshot.val().name + "</td><td>" + childSnapshot.val().destination + "</td><td>" + childSnapshot.val().frequency +"</td>" + "<td id='ntt'>" + nextTrainTime + "</td><td>" + tMinutesTillTrain + "</tr>");
	
      updateTime();

		}, function(errorObject){
			console.log("The read failed: " + errorObject.code);
		});


  	}
  	putOnPage();





  	//when you click
  	$("#add-train").on("click", function(){
  		// Don't refresh the page!
      	event.preventDefault();

        console.log("authenticate: " + localStorage.getItem("authenticate"));

        var getAuth = localStorage.getItem("authenticate");

        if(getAuth === "yes"){





	     name = $("#train-input").val().trim();
	      destination = $("#dest-input").val().trim();
	      frequency = $("#frequency-input").val().trim();
	      ftime = $("#ftime-input").val().trim();

	    //convert ftime into milliary or add validation



		//add to the database and not save over
		//use database.ref().push({})
		database.ref().push({
			name: name,
			destination: destination,
			frequency : frequency,
			ftime : ftime,
			dateAdded: firebase.database.ServerValue.TIMESTAMP


		});


		$("#form")[0].reset();

  } else {

          $('#login-modal').modal('show');

  }


	});

  	//database.ref().on("child_added", function(childSnapshot){
  //	}, function(errorObject){
//
  		//console.log();
  //	});

  //	database.ref().orderByChild("dateAdded").limitToLast(1).on("child_added", function(snapshot) {
  //		$("#name-input").html(snapshot.val().name);
  //	});

  function updateTime(){
  var table = $("#table");
   var rowCount = table.rows.length;
   console.log("rowCount: " + rowCount);

  }

  




	

	</script>

</body>
</html>
